// bot.js (–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨–Æ MULTI-USER –ò –§–ò–ö–°–û–ú RealTime)

import TelegramBot from "node-telegram-bot-api";
import dotenv from "dotenv";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import { GLOBAL, DEFAULTS, MODULE_NAMES } from "./modules/config.js"; 
import { startWsConnections, setGlobalDataHandler } from './modules/wsManager.js'; 
import { // <<< –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ò–ú–ü–û–†–¢
    startScanner, stopScanner, handleKlineUpdate, startCacheUpdater, stopCacheUpdater 
} from './modules/scannerEngine.js'; 

dotenv.config();
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const ACCESS_SECRET_KEY = process.env.ACCESS_SECRET_KEY; 

const TOKEN = process.env.BOT_TOKEN;
if (!TOKEN) {
  console.error("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª.");
  process.exit(1);
}

const bot = new TelegramBot(TOKEN, { polling: true });

// === –£–¢–ò–õ–ò–¢–´ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ===

function formatCash(v){
  if (v == null || isNaN(v)) return "0$";
  const num = Number(v);
  const a = Math.abs(num);
  if (a >= 1e9) return (num/1e9).toFixed(1)+"B$";
  if (a >= 1e6) return (num/1e6).toFixed(1)+"M$";
  if (a >= 1e3) return (num/1e3).toFixed(1)+"K$";
  return num.toFixed(0)+"$"; 
}

function fmtPct(n){
  if (n == null || isNaN(n)) return "‚Äî";
  const s = Number(n);
  return (s >= 0 ? "+" : "") + s.toFixed(2) + "%";
}

function formatCompactUsd(usd) {
    if (usd == null || isNaN(usd) || usd === 0) return '';
    const num = Number(usd);
    const absNum = Math.abs(num);
    
    if (absNum >= 1e9) return `(${(num/1e9).toFixed(2)}B)`;
    if (absNum >= 1e6) return `(${(num/1e6).toFixed(2)}M)`;
    if (absNum >= 1e3) return `(${(num/1e3).toFixed(1)}K)`;
    return `(${(num).toFixed(0)}$)`; 
}


const DATA = path.join(__dirname, "data");
if (!fs.existsSync(DATA)) fs.mkdirSync(DATA, { recursive: true });

function userPath(id){ return path.join(DATA, `${id}.json`); }

function baseUser(){
  return {
    scanning:false,
    hardStop:false,
    exchanges:[...DEFAULTS.exchanges],
    modules:[...DEFAULTS.modules],
    perModuleTF:{...DEFAULTS.perModuleTF},
    sp:{...DEFAULTS.sp},
    pd:{...DEFAULTS.pd},
    div:{...DEFAULTS.div},
    minVolumeUsd: DEFAULTS.minVolumeUsd ?? 10_000_000,
    cooldownSec: DEFAULTS.cooldownSec ?? 1800, 
    _authorized: false,
    _menuMsg:null,
    _askMsg:null,
    _await:null,
    analysisMode: DEFAULTS.analysisMode || 'Closed'
  };
}

function loadUser(id){
  const p = userPath(id);
  if (!fs.existsSync(p)) return baseUser();
  try{
    const u = JSON.parse(fs.readFileSync(p,"utf-8"));
    const merged = { ...baseUser(), ...u };
    
    for (const key of ['sp', 'pd', 'div']) { 
        merged[key] = { ...DEFAULTS[key], ...(u[key] || {}) };
    }
    
    merged.id = id;
    return merged;
  }catch(e){
    return baseUser();
  }
}
function saveUser(id, u){
  try{ fs.writeFileSync(userPath(id), JSON.stringify(u,null,2)); }catch(e){
    console.error(`[‚ùå Save Error] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª ${id}.json:`, e.message);
  }
}

async function deleteMessageSafe(cid, mid){
    if (!mid) return;
    try {
        await bot.deleteMessage(cid, mid);
    } catch(e) {
        
    }
}

async function editOrSend(cid, msgId, text, kb){
  try {
    if (msgId){
      return await bot.editMessageText(text, {
        chat_id: cid, message_id: msgId, parse_mode: "HTML",
        reply_markup: { inline_keyboard: kb }
      });
    }
  }catch(e){
    
  }
  return await bot.sendMessage(cid, text, {
    parse_mode: "HTML",
    reply_markup: { inline_keyboard: kb }
  });
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è Map –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∫–∞–Ω–µ—Ä–∞
if(!global._activeScans) global._activeScans = new Map();

function statusMsg(u){
  const scanData = global._activeScans.get(u.id);
  const isRunning = u.scanning && scanData;

  const mods = (u.modules||[])
    .map(code => `${MODULE_NAMES[code]} (${u.perModuleTF?.[code]||"5m"})
    `.trim())
    .join("\n") || "‚Äî";
  const ex = (u.exchanges||[]).map(x=>x.toUpperCase()).join(" + ") || "‚Äî";
  const volDisplay = formatCash(u.minVolumeUsd).replace('$', ''); 
  const cdMin = Math.floor((u.cooldownSec || 1800) / 60);
  
  const modeDisplay = u.analysisMode === 'RealTime' ? '‚ö° RealTime' : '‚è± Closed';

  const scanDetails = isRunning ? 
    `\n–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—ã:\nBinance: ${scanData.bin || 0}\nBybit: ${scanData.byb || 0}\n–ê–∫—Ç–∏–≤–Ω—ã–µ –¢–§: ${scanData.activeTFs.join(', ')}` : '';

  return `üìü <b>–°—Ç–∞—Ç—É—Å</b>
–ó–∞–ø—É—â–µ–Ω: <b>${isRunning?"–î–∞":"–ù–µ—Ç"}</b>
–†–µ–∂–∏–º: <b>${modeDisplay}</b>
–ë–∏—Ä–∂–∏: <b>${ex}</b>
–§–∏–ª—å—Ç—Ä –æ–±—ä—ë–º–∞: <b>‚â• ${volDisplay}</b>
–ê–Ω—Ç–∏—Å–ø–∞–º (–ö–î): <b>${cdMin} –º–∏–Ω</b>
${scanDetails}

–ú–æ–¥—É–ª–∏:
${mods}`;
}

// =========================================================
// --- –§–£–ù–ö–¶–ò–ò –ú–ï–ù–Æ ---
// =========================================================

async function welcomeMenu(cid) {
  const u = loadUser(cid);

  if (!u._authorized && ACCESS_SECRET_KEY) {
      const text = `
üëã <b>Smart Trader Bot</b>

–î–ª—è –¥–æ—Å—Ç—É–ø–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:
`;
      u._await = { f: "accessKey" }; 
      saveUser(cid, u);
      
      const res = await bot.sendMessage(cid, text, { parse_mode: "HTML" });
      u._askMsg = res.message_id; 
      saveUser(cid, u);
      return;
  }
  
  return showInfoMenu(cid);
}

async function showInfoMenu(cid) {
  const text = `
ü§ñ <b>–û–ó–ù–ê–ö–û–ú–ò–¢–ï–õ–¨–ù–û–ï –ú–ï–ù–Æ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø</b>

–í–∞—à –±–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä—ã–Ω–æ–∫ —Ñ—å—é—á–µ—Ä—Å–æ–≤, –æ–±—ä–µ–¥–∏–Ω—è—è —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫–∏ (–¶–µ–Ω–∞, OI, CVD) –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π.

<b>üöÄ –ö–ê–ö –†–ê–ë–û–¢–ê–Æ–¢ –ú–û–î–£–õ–ò:</b>

‚ö°Ô∏è <b>Smart Trader Bot</b>
    –ò—â–µ—Ç —Ä–∞–Ω–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –ø–æ —Ä–µ–∑–∫–æ–º—É —Å–∫–∞—á–∫—É OI (Open Interest), –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–º—É —Å–∏–ª—å–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º —Ü–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∏–∑–∫–∏–µ –¢–§.

üöÄ <b>–ü–∞–º–ø/–î–∞–º–ø (PD)</b>
    –ò—â–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –º–æ—â–Ω—ã–π –∏–º–ø—É–ª—å—Å: –±–æ–ª—å—à–∞—è —Å–≤–µ—á–∞ + –∞–Ω–æ–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º (Vol√óSMA) + –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ (CVD).

üìà <b>–î–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è (DIV)</b>
    –ò—â–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –º–µ–∂–¥—É —Ü–µ–Ω–æ–π –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º (RSI). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OI/CVD –∫–∞–∫ –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–Ω–¥ –æ—Å–ª–∞–±–µ–≤–∞–µ—Ç.

---
`;

    const kb = [[
        { text: "‚öôÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º", callback_data: "go_auth_or_main" }
    ]];

    const res = await editOrSend(cid, loadUser(cid)._menuMsg, text, kb);
    if (res?.message_id) { 
        const u2 = loadUser(cid); 
        u2._menuMsg = res.message_id; 
        saveUser(cid, u2); 
    }
}


async function mainMenu(cid){
  const u = loadUser(cid);
  const volDisplay = formatCash(u.minVolumeUsd).replace('$', ''); 
  const cdMin = Math.floor((u.cooldownSec || 1800) / 60);
  const mode = u.analysisMode || 'Closed';
  const modeDisplay = mode === 'RealTime' ? '‚ö°Ô∏è RealTime' : '‚è±Ô∏è Closed';

  const kb = [
    [{ text:"ü§ñ –ú–æ–¥—É–ª–∏", callback_data:"mods" }, { text:"‚è± –¢–∞–π–º—Ñ—Ä–µ–π–º—ã", callback_data:"tfmod" }],
    [{ text:"üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ú–æ–¥—É–ª–µ–π", callback_data:"settings" }],
    [{ text: `–†–µ–∂–∏–º –ê–Ω–∞–ª–∏–∑–∞: ${modeDisplay}`, callback_data: "toggle_mode_analysis" }],
    [{ text:"üè¶ –ë–∏—Ä–∂–∏", callback_data:"ex" }, { text:`‚è≥ –ö–î: ${cdMin} –º–∏–Ω`, callback_data:"set_cooldown" }],
    [{ text:`üìä –û–±—ä—ë–º ‚â• ${volDisplay}`, callback_data:"set_volume" }],
    [{ text:"‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫", callback_data:"start" }, { text:"‚õîÔ∏è –°—Ç–æ–ø", callback_data:"stop" }],
    [{ text:"üìü –°—Ç–∞—Ç—É—Å", callback_data:"status" }]
  ];
  const res = await editOrSend(cid, loadUser(cid)._menuMsg, "‚öôÔ∏è <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>", kb);
  if (res?.message_id){ const u2=loadUser(cid); u2._menuMsg=res.message_id; saveUser(cid,u2); }
}

async function modsMenu(cid){
  const u = loadUser(cid);
  const availableModules = Object.keys(MODULE_NAMES).filter(code => ['sp', 'pd', 'div'].includes(code)); 
  const kb = availableModules.map(code => [{
    text: `${u.modules.includes(code)?"‚úÖ":"‚òëÔ∏è"} ${MODULE_NAMES[code]}`,
    callback_data: "mod_"+code
  }]);
  kb.push([{ text:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data:"back" }]);
  const r = await editOrSend(cid,u._menuMsg,"–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏:",kb);
  if(r?.message_id){u._menuMsg=r.message_id;saveUser(cid,u);}
}

async function tfModulesMenu(cid){
  const u = loadUser(cid);
  const availableModules = Object.keys(MODULE_NAMES).filter(code => ['sp', 'pd', 'div'].includes(code));
  const kb = availableModules.map(code => [{
    text: `${MODULE_NAMES[code]} (${u.perModuleTF?.[code]||"5m"})`,
    callback_data: "tftoggle_"+code
  }]);
  kb.push([{ text:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data:"back" }]);
  const r = await editOrSend(cid,u._menuMsg,"‚è± –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è:",kb);
  if(r?.message_id){u._menuMsg=r.message_id;saveUser(cid,u);}
}

async function settingsMenu(cid){
  const u = loadUser(cid);
  const availableModules = Object.keys(MODULE_NAMES).filter(code => ['sp', 'pd', 'div'].includes(code));
  const kb = availableModules.map(code => [{
    text: MODULE_NAMES[code], 
    callback_data: "set_"+code 
  }]);
  kb.push([{ text:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data:"back" }]);
  const r = await editOrSend(cid, u._menuMsg, "üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª–µ–π:", kb);
  if (r?.message_id){ u._menuMsg=r.message_id; saveUser(cid,u); }
}

async function exMenu(cid){ 
  const u = loadUser(cid);
  const availableExchanges = ["binance", "bybit"];
  const kb = availableExchanges.map(ex => [{
    text: `${u.exchanges.includes(ex) ? "‚úÖ" : "‚òëÔ∏è"} ${ex.toUpperCase()}`,
    callback_data: "toggle_ex_" + ex
  }]);
  kb.push([{ text:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data:"back" }]);
  return editOrSend(cid, u._menuMsg, "–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –±–∏—Ä–∂–∏:", kb);
}

// === –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ ===

async function showSPMenu(cid){
  const u = loadUser(cid);
  const set = u.sp;
  
  const kb = [
    [{ text:`–ú–∏–Ω. OI % LONG: ${Number(set.oiPlusPct).toFixed(2)}%`, callback_data:"sp_oiplus" }],
    // –ö–Ω–æ–ø–∫–∞ CVD USD —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –º–µ–Ω—é
    [{ text:`‚¨ÖÔ∏è –ù–∞–∑–∞–¥`, callback_data:"settings" }]
  ];
  
  return editOrSend(cid, u._menuMsg, "‚öôÔ∏è <b>Smart Pump</b> (–†–µ–∑–∫–∏–π —Ä–æ—Å—Ç OI)", kb);
}

async function showPDMenu(cid){
  const u = loadUser(cid);
  const set = u.pd;
  const kb = [
    [{ text:`–ú–∏–Ω. –¢–µ–ª–æ %: ${Number(set.minBodyPct).toFixed(2)}%`, callback_data:"pd_body" }],
    [{ text:`–ú–∏–Ω. Vol√óSMA20: ${Number(set.minVolX).toFixed(2)}√ó`, callback_data:"pd_volx" }],
    [{ text:`–ú–∏–Ω. OI %: ${Number(set.oiPct).toFixed(2)}%`, callback_data:"pd_oipct" }],
    [{ text:`–ú–∏–Ω. CVD USD: ${formatCash(set.oiUsdMin)}`, callback_data:"pd_oiminusd" }],
    [{ text:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data:"settings" }]
  ];
  return editOrSend(cid, u._menuMsg, "‚öôÔ∏è <b>Pump/Dump</b> (–¢–µ–ª–æ + –û–±—ä—ë–º + OI)", kb);
}

async function showDIVMenu(cid){
  const u = loadUser(cid);
  const set = u.div;
  const modeString = String(set.mode || 'strict');
  const modeDisplay = modeString.toUpperCase() === 'STRICT' ? '–°–¢–†–û–ì–ò–ô' : '–°–í–û–ë–û–î–ù–´–ô';

  const kb = [
    [{ text:`RSI –ü–µ—Ä–∏–æ–¥: ${Number(set.rsiPeriod)}`, callback_data:"div_rsi" }],
    [{ text:`–ú–∏–Ω. –†–∞–∑–Ω–∏—Ü–∞ RSI: ${Number(set.rsiMinDiff)}`, callback_data:"div_diff" }], 
    [{ text:`MACD Fast: ${Number(set.macdFast)}`, callback_data:"div_fast" }, { text:`MACD Slow: ${Number(set.macdSlow)}`, callback_data:"div_slow" }],
    [{ text:`MACD Signal: ${Number(set.macdSignal)}`, callback_data:"div_signal" }],
    [{ text:`–†–µ–∂–∏–º: ${modeDisplay}`, callback_data:"div_toggle_mode" }], 
    [{ text:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data:"settings" }]
  ];
  return editOrSend(cid, u._menuMsg, "‚öôÔ∏è <b>Divergence</b> (–î–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è)", kb);
}
// -----------------------------------------------------------------


// --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è Telegram ---

function formatSignalForTg(r){
    const arrow = r.side === '–õ–æ–Ω–≥' ? 'üü¢' : 'üî¥';
    const kind = r.kind || r.reason;
    const tf = r.detail?.signalTf || 'N/A';
    
    const mode = r.detail?.signalMode || 'Closed';
    const modeEmoji = mode === 'RealTime' ? '‚ö°Ô∏è' : '‚è±Ô∏è';
    
    const oiPct = r.detail?.oi != null ? fmtPct(r.detail.oi) : '‚Äî';
    const cvd = r.detail?.cvd != null ? formatCash(r.detail.cvd) : '‚Äî';
    
    let oiElement = oiPct;
    if (r.detail?.deltaOIUsd != null) {
        const oiUsdCompact = formatCompactUsd(r.detail.deltaOIUsd);
        if (oiPct !== '‚Äî' && oiUsdCompact) {
            oiElement = `${oiPct} ${oiUsdCompact}`;
        } else if (oiUsdCompact) {
            oiElement = oiUsdCompact;
        }
    }
    
    let extraDetails = [];
    let headerEmoji = 'üö®';
    let cvdDisplay = cvd;
    let mainMetrics = [];

    if (kind.includes('Smart Pump')) {
        headerEmoji = '‚ö°Ô∏è';
        const pricePct = r.detail?.priceChangePct ? fmtPct(r.detail.priceChangePct) : '‚Äî';
        const spCount = r.detail?.smartPumpCount24h ?? '‚Äî';
        
        mainMetrics.push(`üìà Œî% –¶–µ–Ω—ã: ${pricePct}`);
        extraDetails.push(`*–ü–æ–≤—Ç–æ—Ä—ã 24—á:* ${spCount}√ó`);
    }
    else if (kind.includes('PUMP') || kind.includes('DUMP')) {
        headerEmoji = 'üöÄ';
        const pricePct = r.detail?.priceChangePct ? fmtPct(r.detail.priceChangePct) : '‚Äî';
        mainMetrics.push(`üìà Œî% –¶–µ–Ω—ã: ${pricePct}`);
    }
    else if (kind.includes('–î–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è')) {
        headerEmoji = 'üìà';
        const rsiVal = r.detail.rNow.toFixed(0);
        const rsiPrev = r.detail.rPrev.toFixed(0);
        const volMult = r.detail?.volMult ? r.detail.volMult.toFixed(1) : '‚Äî';
        
        const rsiDiff = r.detail.rNow - r.detail.rPrev;
        const divType = r.side === '–õ–æ–Ω–≥' ? '–ë—ã—á—å—è (Bullish)' : '–ú–µ–¥–≤–µ–∂—å—è (Bearish)';
        const rsiTrend = r.side === '–õ–æ–Ω–≥' ? `(${rsiVal} > ${rsiPrev})` : `(${rsiVal} < ${rsiPrev})`;
        const rsiZone = r.side === '–õ–æ–Ω–≥' ? (rsiVal < 30 ? '‚úÖ OS (<30)' : '‚ùå') : (rsiVal > 70 ? '‚úÖ OB (>70)' : '‚ùå');
        
        extraDetails.push(`\n*–¢–∏–ø –î–∏–≤–µ—Ä:* ${divType}`);
        extraDetails.push(`*RSI:* ${rsiVal} ${rsiTrend} (Œî${rsiDiff.toFixed(0)})`);
        extraDetails.push(`*–ó–æ–Ω–∞ RSI:* ${rsiZone}`); 
        extraDetails.push(`*Vol√ó:* ${volMult}`);
        
        if (r.detail.macdNow && r.detail.signalNow) {
            
            if (r.reason.includes('MACD Confirmed')) {
                const isBull = r.side === '–õ–æ–Ω–≥';
                const action = isBull ? '–ø–µ—Ä–µ—Å–µ–∫–ª–∞ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö' : '–ø–µ—Ä–µ—Å–µ–∫–ª–∞ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑';
                const zoneText = isBull ? '–≤ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –∑–æ–Ω–µ (‚â§0)' : '–≤ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π –∑–æ–Ω–µ (‚â•0)';
                extraDetails.push(`*MACD –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (S3):*`);
                extraDetails.push(`  - –ë—ã—Å—Ç—Ä–∞—è –ª–∏–Ω–∏—è ${action} —Å–∏–≥–Ω–∞–ª—å–Ω—É—é.`);
                extraDetails.push(`  - –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ ${zoneText}.`); 
            } else if (r.reason.includes('CVD Confirmed' || r.reason.includes('OI Confirmed'))) {
                extraDetails.push(`*–î–æ–ø. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (S2):* –î–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ –∏–ª–∏ OI –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç —Ä–∞–∑–≤–æ—Ä–æ—Ç.`);
            }
        }
    }

    const metricsLine = mainMetrics.join(' | ');

    return `
${headerEmoji} *${kind}* ‚Ä¢ ${r.exchange}
*${r.symbol}* ‚Ä¢ ${tf} | –†–µ–∂–∏–º: ${modeEmoji} ${mode} ${arrow}
---
*–¶–µ–Ω–∞:* ${r.price.toFixed(r.price > 100 ? 2 : 4)}$
${metricsLine ? metricsLine : ''}
---
*üí∞ OI Œî:* ${oiElement}
*üíµ CVD Œî:* ${cvdDisplay}${extraDetails.length > 0 ? '\n' + extraDetails.join('\n') : ''}
    
*–í—Ä–µ–º—è:* ${new Date(r.ts).toLocaleTimeString()}`.trim();
}

/* Scanner Logic - –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê WS */

const onSignal = async (sig) => {
    const userIds = Array.from(global._activeScans.keys()); 
    await Promise.all(userIds.map(async (cid) => {
        const u = loadUser(cid);
        if(u.scanning && global._activeScans.has(cid)){
             await bot.sendMessage(cid, formatSignalForTg(sig), { parse_mode: "Markdown" });
        }
    }));
};

// >>> NEW/FIXED: –õ–û–ì–ò–ö–ê handleWsData –î–õ–Ø RealTime/Closed
function handleWsData(exchange, data) {
    let newKlineData = null;
    let symbol = null;
    let tf = null;
    let isClosed = false; 
    
    let cid = global._activeScans.keys().next().value; 

    if (!cid) return;

    const u = loadUser(cid);
    const mode = u.analysisMode || 'Closed';

    if (exchange === 'binance' && data.e === 'kline') {
        newKlineData = data.k;
        symbol = data.k.s;
        tf = data.k.i;
        isClosed = data.k.x; 
    } else if (exchange === 'bybit' && data.topic && data.topic.startsWith('kline') && data.data && data.data[0]) {
        const parts = data.topic.split('.');
        tf = parts[1];
        symbol = parts[2];
        newKlineData = data.data[0];
        isClosed = data.data[0].confirm; 
    }
    
    if (newKlineData && symbol && tf) {
        
        // 1. –ê–Ω–∞–ª—ñ–∑ –ó–ê–ö–†–ò–¢–û–á —Å–≤—ñ—á–∫–∏ (–ù–∞–¥—ñ–π–Ω–∏–π: isClosed = true, isRealTime = false)
        if (isClosed) {
            handleKlineUpdate(exchange, symbol, tf, newKlineData, true, false, u); 
            return; 
        }
        
        // 2. –ê–Ω–∞–ª—ñ–∑ –†–ï–ê–õ–¨–ù–û–ì–û –ß–ê–°–£ (–®–≤–∏–¥–∫–∏–π: isClosed = false, isRealTime = true)
        if (mode === 'RealTime') {
            handleKlineUpdate(exchange, symbol, tf, newKlineData, false, true, u); 
        }
        
        // 3. –ë–∞–∑–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–¥–ª—è Closed Mode)
        if (mode === 'Closed') {
             // –ü—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å–≤—ñ—á–∫—É –≤ –∫–µ—à—ñ, –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—á–∏ –∞–Ω–∞–ª—ñ–∑
             handleKlineUpdate(exchange, symbol, tf, newKlineData, false, false, u); 
        }
    }
}
// ------------------------------------------------------------------

/* Value input */

bot.on("message", async (msg)=>{
  try{
    const cid=msg.chat.id;
    const mid=msg.message_id;
    const u=loadUser(cid);
    
    if (u._await && u._await.f === "accessKey") {
        const inputKey = String(msg.text || "").trim();
        await deleteMessageSafe(cid, mid);
        await deleteMessageSafe(cid, u._askMsg);

        u._askMsg = null;
        u._await = null;
        
        if (inputKey === ACCESS_SECRET_KEY) {
            u._authorized = true;
            saveUser(cid, u);
            bot.sendMessage(cid, "‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω! –ó–∞–≥—Ä—É–∂–∞—é –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", { parse_mode: "HTML" });
            return mainMenu(cid);
        } else {
            saveUser(cid, u);
            return bot.sendMessage(cid, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start.");
        }
    }

    if(!u._await) return;

    const raw=String(msg.text||"").trim();
    const val=parseFloat(raw.replace(/[^0-9.\-]/g,""));
    
    if(!isFinite(val) || val < 0){
      await deleteMessageSafe(cid, mid);
      await deleteMessageSafe(cid, u._askMsg);
      mainMenu(cid); 
      return bot.sendMessage(cid,"‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.");
    }
    
    const {m, f} = u._await;

    if(f==="minVolumeUsd"){
      let x = val;
      if(x < 1e3 && x > 0) x = x * 1000000;
      u.minVolumeUsd = Math.max(1000000, Math.round(x));
    } 
    else if (f === "cooldownSec") {
        u.cooldownSec = Math.max(60, Math.round(val));
    } 
    else if (m && f){
      u[m][f]=val;
    }

    await deleteMessageSafe(cid, u._askMsg); 
    await deleteMessageSafe(cid, mid); 

    u._askMsg=null;u._await=null;saveUser(cid,u);
    
    switch(f){ 
        case "minVolumeUsd":
        case "cooldownSec":
            return mainMenu(cid);
        default:
            switch(m){
                case "sp": 
                    if (f === "minCVDUsd" || f === "oiPlusPct") return showSPMenu(cid); 
                    return showSPMenu(cid);
                case "pd": return showPDMenu(cid);
                case "div": return showDIVMenu(cid);
                default: return mainMenu(cid); 
            }
    }
  }catch(e){
    mainMenu(msg.chat.id); 
  }
});

/* Callbacks */

bot.on("callback_query",async(q)=>{
  const cid=q.message.chat.id;
  const d=q.data;
  const u=loadUser(cid);
  
  if (!u._authorized && ACCESS_SECRET_KEY && d !== "go_auth_or_main") {
      return bot.sendMessage(cid, "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á.", { parse_mode: "HTML" });
  }

  await deleteMessageSafe(cid, u._askMsg);
  u._askMsg = null;
  u._await = null;

  u._menuMsg=q.message.message_id;saveUser(cid,u);

  const ask=async(field,m,msg)=>{
    u._await={m,f:field};saveUser(cid,u);
    const m2=await bot.sendMessage(cid,msg,{parse_mode:"HTML"});
    u._askMsg=m2.message_id;saveUser(cid,u);
  };
  
  const map={
    // Smart Pump (SP)
    sp_oiplus:      ()=>ask("oiPlusPct","sp","–í–≤–µ–¥–∏—Ç–µ OI+ % (–ú–∏–Ω. OI %):"),
    //sp_cvd: –£–î–ê–õ–ï–ù–ê –ò–ó MAP
    // Pump/Dump (PD)
    pd_body:        ()=>ask("minBodyPct","pd","–ú–∏–Ω. –¢–µ–ª–æ %:"),
    pd_volx:        ()=>ask("minVolX","pd","–ú–∏–Ω. Vol√óSMA20:"),
    pd_oipct:       ()=>ask("oiPct","pd","–ú–∏–Ω. OI %:"), 
    pd_oiminusd:    ()=>ask("oiUsdMin","pd","–ú–∏–Ω. CVD USD:"), 
    // Divergence (DIV)
    div_rsi:        ()=>ask("rsiPeriod","div","RSI –ü–µ—Ä–∏–æ–¥:"),
    div_diff:       ()=>ask("rsiMinDiff","div","–ú–∏–Ω. —Ä–∞–∑–Ω–∏—Ü–∞ RSI:"), 
    div_fast:       ()=>ask("macdFast","div","MACD Fast –ü–µ—Ä–∏–æ–¥:"), 
    div_slow:       ()=>ask("macdSlow","div","MACD Slow –ü–µ—Ä–∏–æ–¥:"), 
    div_signal:     ()=>ask("macdSignal","div","MACD Signal –ü–µ—Ä–∏–æ–¥:"), 
    "div_toggle_mode": async()=>{
        const currentMode = String(u.div.mode || 'strict').toUpperCase();
        u.div.mode = (currentMode === 'STRICT' || currentMode === '–°–¢–†–û–ì–ò–ô') ? 'relaxed' : 'strict';
        saveUser(cid, u);
        return showDIVMenu(cid);
    },
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    set_volume:     ()=>ask("minVolumeUsd", null, `–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º USD (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10000000 –∏–ª–∏ 10M). –¢–µ–∫—É—â–µ–µ: ${formatCash(u.minVolumeUsd)}`),
    set_cooldown:   ()=>ask("cooldownSec", null, `–í–≤–µ–¥–∏—Ç–µ –ê–Ω—Ç–∏—Å–ø–∞–º –ö–î (—Å–µ–∫). –¢–µ–∫—É—â–µ–µ: ${u.cooldownSec} —Å–µ–∫`),
  };

  if(map[d])return map[d]();

  if(d==="go_auth_or_main"){
      const isAuthRequired = ACCESS_SECRET_KEY && !u._authorized;
      
      if (isAuthRequired) {
          const text = `–î–ª—è –¥–æ—Å—Ç—É–ø–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:`;
          u._await = { f: "accessKey" }; 
          saveUser(cid, u);
          
          const res = await bot.sendMessage(cid, text, { parse_mode: "HTML" });
          u._askMsg = res.message_id; 
          saveUser(cid, u);
          return;
      }
      return mainMenu(cid); 
  }
  
  if(d==="toggle_mode_analysis"){
      const currentMode = u.analysisMode || 'Closed';
      u.analysisMode = (currentMode === 'Closed') ? 'RealTime' : 'Closed';
      saveUser(cid, u);
      return mainMenu(cid);
  }
  
  if(d==="go_main")return mainMenu(cid);
  if(d==="mods")return modsMenu(cid);
  if(d==="tfmod")return tfModulesMenu(cid);
  if(d==="settings")return settingsMenu(cid);
  if(d==="back")return mainMenu(cid);
  if(d==="ex")return exMenu(cid); 
  if(d==="status")return bot.sendMessage(cid,statusMsg(u),{parse_mode:"HTML"});
  
  if (d.startsWith("toggle_ex_")){
    const exCode = d.replace("toggle_ex_","");
    const s = new Set(u.exchanges);
    s.has(exCode) ? s.delete(exCode) : s.add(exCode);
    u.exchanges = [...s]; saveUser(cid,u);
    return exMenu(cid);
  }

  if(d.startsWith("mod_")){
    const code = d.replace("mod_","");
    const s=new Set(u.modules); s.has(code)?s.delete(code):s.add(code);
    u.modules=[...s];saveUser(cid,u);
    return modsMenu(cid);
  }

  if(d.startsWith("tftoggle_")){
    const code = d.replace("tftoggle_","");
    const validTfs = ["5m", "15m", "1h", "4h"];
    const currentTf = u.perModuleTF[code] || "5m";
    const currentIndex = validTfs.indexOf(currentTf);
    const nextIndex = (currentIndex + 1) % validTfs.length;
    u.perModuleTF[code] = validTfs[nextIndex];

    saveUser(cid,u);
    return tfModulesMenu(cid);
  }

  if(d.startsWith("set_")){
    const code = d.replace("set_","");
    switch(code){
      case "sp": return showSPMenu(cid);
      case "pd": return showPDMenu(cid);
      case "div": return showDIVMenu(cid);
      default: return settingsMenu(cid);
    }
  }

  if(d==="start"){
    if(global._activeScans.has(cid)){
         await bot.sendMessage(cid, "‚ö†Ô∏è –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ.");
         return;
    }
    const u2 = loadUser(cid);
    if(!u2.modules || u2.modules.length===0){
        await bot.sendMessage(cid, "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–æ–¥—É–ª—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.");
        return;
    }
    if(!u2.exchanges || u2.exchanges.length===0){
        await bot.sendMessage(cid, "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –±–∏—Ä–∂—É.");
        return;
    }
    
    u2.scanning=true;u2.hardStop=false;saveUser(cid,u2);
    
    await bot.sendMessage(cid, `‚è≥ –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞... –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ WebSockets. (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)`);
    
    setGlobalDataHandler(handleWsData);
    startWsConnections(); 
    
    try {
        const activeUserIds = Array.from(global._activeScans.keys());
        if (!activeUserIds.includes(cid)) activeUserIds.push(cid);

        const { bin, byb, activeTFs, symbols } = await startScanner(u2, activeUserIds, cid, onSignal);
        
        startCacheUpdater(); 
        
        global._activeScans.set(cid, {
            bin,
            byb,
            activeTFs,
        });
        
        const volM=(u2.minVolumeUsd/1e6).toFixed(1);

        await bot.sendMessage(cid,`‚úÖ –°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
–ë–∏—Ä–∂–∏: Binance (${bin} –ø–∞—Ä), Bybit (${byb} –ø–∞—Ä)
–ê–∫—Ç–∏–≤–Ω—ã–µ –¢–§: ${activeTFs.join(', ')}
üìä –§–∏–ª—å—Ç—Ä: Vol ‚â• $${volM}M`);
    } catch (e) {
        console.error("Start scanner error:", e.message);
        u2.scanning=false;u2.hardStop=true;saveUser(cid,u2);
        await bot.sendMessage(cid, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: ${e.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏.`);
    }

    return;
  }

  if(d==="stop"){
    if(!global._activeScans.has(cid)){
        await bot.sendMessage(cid, "üõë –°–∫–∞–Ω–µ—Ä –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω.");
        const u2 = loadUser(cid);
        u2.scanning=false;u2.hardStop=true;saveUser(cid,u2);
        return;
    }
    
    const u2 = loadUser(cid);
    u2.scanning=false;u2.hardStop=true;saveUser(cid,u2);
    
    const { bin, byb } = global._activeScans.get(cid);
    
    await stopScanner(u2, cid); 
    
    global._activeScans.delete(cid); 

    stopCacheUpdater(); 
    
    await bot.sendMessage(cid,"üõë –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –û—Ç–ø–∏—Å–∫–∞ –æ—Ç WebSockets –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.");
    return bot.sendMessage(cid, `üìä Binance:${bin} | Bybit:${byb}`);
  }
});

/* /start command */

bot.onText(/\/start/, async msg=>{
  const cid=msg.chat.id;
  const u=loadUser(cid);
  u.scanning=false;u.hardStop=false;
  
  if (!u._authorized) {
      u._authorized = false; 
  }

  saveUser(cid,u);
  return welcomeMenu(cid);
});

bot.onText(/\/menu/, async msg => {
    const cid = msg.chat.id;
    const u = loadUser(cid);
    if (!u._authorized && ACCESS_SECRET_KEY) {
        return welcomeMenu(cid);
    }
    return mainMenu(cid);
});

bot.onText(/\/status/, async msg => {
    const cid = msg.chat.id;
    const u = loadUser(cid);
    if (!u._authorized && ACCESS_SECRET_KEY) {
        return welcomeMenu(cid);
    }
    return bot.sendMessage(cid, statusMsg(u), { parse_mode: "HTML" });
});

bot.onText(/\/stop/, async msg => {
    const cid = msg.chat.id;
    const q = { message: { chat: { id: cid, type: 'private' }, message_id: msg.message_id }, data: "stop" }; 
    return bot.emit('callback_query', q);
});

bot.onText(/\/run/, async msg => {
    const cid = msg.chat.id;
    const q = { message: { chat: { id: cid, type: 'private' }, message_id: msg.message_id }, data: "start" }; 
    return bot.emit('callback_query', q);
});

console.log("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –û–∂–∏–¥–∞–µ–º –∫–æ–º–∞–Ω–¥...");